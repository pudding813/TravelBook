<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Travel - éš¨å¿ƒæ—…éŠè¦åŠƒ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .suggestions-list {
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        
        .date-input-custom::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.6;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"><div class="text-center mt-20 text-slate-400">æ­£åœ¨å•Ÿå‹• Vibe Travel...</div></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Icons ---
        const Icon = ({ children, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const PlusIcon = (p) => <Icon {...p}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></Icon>;
        const Trash2Icon = (p) => <Icon {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></Icon>;
        const NavigationIcon = (p) => <Icon {...p}><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></Icon>;
        const ClockIcon = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></Icon>;
        const Edit3Icon = (p) => <Icon {...p}><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></Icon>;
        const CheckIcon = (p) => <Icon {...p}><polyline points="20 6 9 17 4 12"></polyline></Icon>;
        const RefreshCwIcon = (p) => <Icon {...p}><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></Icon>;
        const CalculatorIcon = (p) => <Icon {...p}><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="16" y1="18" x2="16" y2="18"></line><line x1="12" y1="18" x2="12" y2="18"></line><line x1="8" y1="18" x2="8" y2="18"></line></Icon>;
        const ArrowRightLeftIcon = (p) => <Icon {...p}><path d="m16 7 5 5-5 5"/><path d="M21 12H3"/><path d="m8 17-5-5 5-5"/></Icon>;
        const SearchIcon = (p) => <Icon {...p}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></Icon>;
        const DollarSignIcon = (p) => <Icon {...p}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></Icon>;
        const CloudIcon = (p) => <Icon {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></Icon>;
        const SunIcon = (p) => <Icon {...p}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></Icon>;
        const CloudRainIcon = (p) => <Icon {...p}><line x1="16" y1="13" x2="16" y2="21"></line><line x1="8" y1="13" x2="8" y2="21"></line><line x1="12" y1="15" x2="12" y2="23"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></Icon>;
        const SaveIcon = (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></Icon>;
        const HeartIcon = (p) => <Icon {...p}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></Icon>;
        const WalletIcon = (p) => <Icon {...p}><rect x="2" y="5" width="20" height="14" rx="2" ry="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></Icon>;
        const CalendarIcon = (p) => <Icon {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></Icon>;
        const LoaderIcon = (p) => <Icon {...p} className={`${p.className} animate-spin`}><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></Icon>;
        const DownloadIcon = (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></Icon>;

        // --- Utils ---
        const getWeatherIcon = (code) => {
            if (code <= 1) return <SunIcon className="w-8 h-8 text-yellow-500" />;
            if (code <= 3) return <CloudIcon className="w-8 h-8 text-slate-400" />;
            if (code >= 51) return <CloudRainIcon className="w-8 h-8 text-blue-400" />;
            return <CloudIcon className="w-8 h-8 text-slate-400" />;
        };
        const getWeatherDesc = (code) => {
             if (code === 0) return 'æ™´æœ—';
             if (code <= 3) return 'å¤šé›²';
             if (code <= 48) return 'éœ§';
             if (code <= 67) return 'ç´°é›¨';
             if (code <= 82) return 'é™£é›¨';
             if (code <= 99) return 'é›·é›¨';
             return 'å¤šé›²';
        };
        const getTodayDate = () => {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        };

        // --- Optimized Smart Search Input ---
        const SmartLocationInput = ({ value, onChange, placeholder, required, onSelectCallback }) => {
            const [suggestions, setSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const wrapperRef = useRef(null);
            const timeoutRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setShowSuggestions(false);
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const handleSearch = (query) => {
                onChange(query);
                if (timeoutRef.current) clearTimeout(timeoutRef.current);
                if (query.length < 2) { setSuggestions([]); return; }
                setIsLoading(true);
                timeoutRef.current = setTimeout(async () => {
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&accept-language=zh-TW&limit=5`);
                        const data = await response.json();
                        setSuggestions(data);
                        setShowSuggestions(true);
                    } catch (e) { console.error(e); } finally { setIsLoading(false); }
                }, 500);
            };

            const handleSelect = (item) => {
                const name = item.display_name.split(',')[0];
                onChange(name);
                setShowSuggestions(false);
                if (onSelectCallback) onSelectCallback(item);
            };

            return (
                <div className="relative flex-grow" ref={wrapperRef}>
                    <div className="relative">
                        <input
                            type="text"
                            placeholder={placeholder}
                            required={required}
                            value={value}
                            onChange={(e) => handleSearch(e.target.value)}
                            onFocus={() => value.length >= 2 && setShowSuggestions(true)}
                            className="w-full pl-4 pr-10 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 bg-white text-sm text-slate-700 shadow-sm"
                        />
                        {isLoading && <div className="absolute right-3 top-1/2 -translate-y-1/2"><LoaderIcon className="w-4 h-4 text-indigo-500" /></div>}
                    </div>
                    {showSuggestions && suggestions.length > 0 && (
                        <div className="absolute left-0 right-0 top-full mt-1 bg-white rounded-xl shadow-xl border border-slate-100 z-50 suggestions-list">
                            {suggestions.map((item, idx) => (
                                <div key={idx} onClick={() => handleSelect(item)} className="px-4 py-3 hover:bg-indigo-50 cursor-pointer text-sm text-slate-700 border-b border-slate-50 flex items-center gap-3 transition-colors active:bg-indigo-100">
                                    <SearchIcon className="w-4 h-4 text-slate-400 flex-shrink-0" />
                                    <span className="truncate font-medium">{item.display_name}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- Add Activity Form (Ultra Clean - No Icon) ---
        const AddActivityForm = ({ onAdd }) => {
            const [time, setTime] = useState('10:00');
            const [location, setLocation] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if (location.trim()) {
                    onAdd(time, location);
                    setLocation('');
                }
            };
            return (
                <form onSubmit={handleSubmit} className="flex gap-2 w-full p-4 bg-white/50 backdrop-blur-sm rounded-2xl border border-slate-200 shadow-sm mb-6">
                     {/* Time: Cleaned up, no icon, reduced width, removed extra left padding */}
                     <div className="relative flex-shrink-0">
                        <input 
                            value={time} 
                            onChange={(e) => setTime(e.target.value)} 
                            type="time" 
                            required 
                            className="w-[90px] px-2 py-3 rounded-xl border border-slate-200 bg-white text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500/20 text-center"
                        />
                    </div>
                    <div className="flex-grow">
                        <SmartLocationInput value={location} onChange={setLocation} placeholder="æœå°‹è¡Œç¨‹åœ°é»..." required={true} />
                    </div>
                    <button type="submit" className="bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl px-4 py-2 font-bold shadow-md shadow-indigo-200 active:scale-95 transition-transform flex-shrink-0"><PlusIcon className="w-6 h-6"/></button>
                </form>
            );
        };

        // --- Activity Item ---
        const ActivityItem = ({ act, onDelete, onUpdate }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [tempTime, setTempTime] = useState(act.time);
            const [tempLoc, setTempLoc] = useState(act.location);

            const handleSave = () => {
                if(tempLoc.trim()){
                    onUpdate(act.id, tempTime, tempLoc);
                    setIsEditing(false);
                }
            };

            if(isEditing) {
                return (
                    <div className="bg-white p-4 rounded-2xl border-2 border-indigo-200 flex flex-col gap-3 shadow-lg z-10 relative">
                        <div className="flex items-center gap-2">
                            <input type="time" value={tempTime} onChange={e=>setTempTime(e.target.value)} className="p-2 rounded-lg border border-slate-200 text-sm font-bold w-32"/>
                            <div className="flex-grow">
                                <SmartLocationInput value={tempLoc} onChange={setTempLoc} placeholder="ä¿®æ”¹åœ°é»" required={true}/>
                            </div>
                        </div>
                        <div className="flex justify-end gap-2">
                            <button onClick={()=>setIsEditing(false)} className="px-3 py-1 text-sm text-slate-500 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                            <button onClick={handleSave} className="px-3 py-1 text-sm text-white bg-indigo-600 rounded-lg flex items-center gap-1 shadow-md"><SaveIcon className="w-3 h-3"/> å„²å­˜</button>
                        </div>
                    </div>
                )
            }

            return (
                <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-start gap-3 transition-transform hover:-translate-y-0.5 group">
                    <div className="bg-indigo-50 text-indigo-600 text-xs font-bold px-2 py-1 rounded-lg mt-0.5 border border-indigo-100">{act.time}</div>
                    <div className="flex-grow">
                        <div className="font-bold text-slate-800 text-lg cursor-pointer hover:text-indigo-600" onClick={()=>window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(act.location)}`, '_blank')}>{act.location}</div>
                        <div className="flex items-center gap-2 mt-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                            <button onClick={()=>window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(act.location)}`, '_blank')} className="text-xs flex items-center gap-1 bg-slate-100 hover:bg-indigo-100 text-slate-600 hover:text-indigo-600 px-3 py-1.5 rounded-full transition-colors">
                                <NavigationIcon className="w-3 h-3"/> å°èˆª
                            </button>
                            <button onClick={()=>setIsEditing(true)} className="text-xs flex items-center gap-1 text-slate-400 hover:text-indigo-500 px-2 py-1.5">
                                <Edit3Icon className="w-3 h-3"/> ç·¨è¼¯
                            </button>
                            <button onClick={onDelete} className="text-xs text-slate-300 hover:text-red-400 px-2 py-1.5">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Expense Tracker Component (Prominent Date) ---
        const ExpenseTracker = ({ rates }) => {
            const [expenses, setExpenses] = useState(() => {
                const s = localStorage.getItem('vibeExpenses');
                return s ? JSON.parse(s) : [];
            });
            const [tripDefaultCurrency, setTripDefaultCurrency] = useState(() => {
                return localStorage.getItem('vibeExpenseDefaultCurrency') || 'JPY';
            });

            // State
            const [date, setDate] = useState(getTodayDate());
            const [item, setItem] = useState('');
            const [amount, setAmount] = useState('');
            const [editingId, setEditingId] = useState(null);

            // Sync with LocalStorage
            useEffect(() => { localStorage.setItem('vibeExpenses', JSON.stringify(expenses)); }, [expenses]);
            useEffect(() => { localStorage.setItem('vibeExpenseDefaultCurrency', tripDefaultCurrency); }, [tripDefaultCurrency]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!item || !amount || !rates) return;
                
                // Use default currency
                const rate = rates[tripDefaultCurrency];
                const twdAmount = parseFloat(amount) / rate;

                if (editingId) {
                    setExpenses(expenses.map(ex => ex.id === editingId ? { 
                        ...ex, date, item, amount: parseFloat(amount), currency: tripDefaultCurrency, twdAmount 
                    } : ex));
                    setEditingId(null);
                } else {
                    const newExpense = { 
                        id: Date.now(), date, item, amount: parseFloat(amount), currency: tripDefaultCurrency, twdAmount 
                    };
                    setExpenses([newExpense, ...expenses]);
                }
                
                // Clear inputs, keep date
                setItem('');
                setAmount('');
            };

            const handleEdit = (ex) => {
                setDate(ex.date || getTodayDate());
                setItem(ex.item);
                setAmount(ex.amount);
                setEditingId(ex.id);
            };

            const handleDelete = (id) => {
                setExpenses(expenses.filter(ex => ex.id !== id));
            };

            const totalTWD = expenses.reduce((acc, curr) => acc + curr.twdAmount, 0);

            const expensesByDate = useMemo(() => {
                const grouped = {};
                expenses.forEach(ex => {
                    const d = ex.date || 'æœªè¨­å®šæ—¥æœŸ';
                    if (!grouped[d]) grouped[d] = { items: [], total: 0 };
                    grouped[d].items.push(ex);
                    grouped[d].total += ex.twdAmount;
                });
                return Object.keys(grouped).sort().reverse().map(date => ({ date, ...grouped[date] }));
            }, [expenses]);

            return (
                <div className="fade-in space-y-6 pb-20">
                    
                    {/* Settings Row */}
                    <div className="flex justify-between items-center px-2">
                        <h3 className="text-sm font-bold text-slate-500">è²¡å‹™è¨­å®š</h3>
                        <div className="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full border border-slate-200 shadow-sm">
                            <span className="text-xs text-slate-400">æ—…ç¨‹é è¨­å¹£åˆ¥:</span>
                            <select value={tripDefaultCurrency} onChange={(e) => setTripDefaultCurrency(e.target.value)} className="text-sm font-bold text-indigo-600 bg-transparent outline-none cursor-pointer">
                                <option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option>
                                <option value="USD">ğŸ‡ºğŸ‡¸ USD</option>
                                <option value="KRW">ğŸ‡°ğŸ‡· KRW</option>
                                <option value="EUR">ğŸ‡ªğŸ‡º EUR</option>
                                <option value="CNY">ğŸ‡¨ğŸ‡³ CNY</option>
                                <option value="TWD">ğŸ‡¹ğŸ‡¼ TWD</option>
                            </select>
                        </div>
                    </div>

                    {/* Summary - RED Text */}
                    <div className="bg-white rounded-3xl p-6 shadow-lg shadow-slate-200 border border-slate-100">
                        <div className="flex items-center gap-2 opacity-60 mb-1 text-slate-500">
                            <WalletIcon className="w-5 h-5"/> æ—…è²»ç¸½æ”¯å‡º (é ä¼°)
                        </div>
                        <div className="text-4xl font-extrabold text-red-600">
                            NT$ {Math.round(totalTWD).toLocaleString()}
                        </div>
                    </div>

                    {/* Input Form - Prominent Date */}
                    <form onSubmit={handleSubmit} className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col gap-3">
                        
                        {/* Row 1: Date | Amount */}
                        <div className="flex gap-2 items-center h-12">
                            {/* Date: Prominent and Longer */}
                            <input 
                                type="date" 
                                value={date} 
                                onChange={e=>setDate(e.target.value)}
                                required
                                className="h-full w-[160px] px-3 bg-emerald-50 rounded-xl border-2 border-emerald-100 outline-none text-sm font-bold text-emerald-900 focus:ring-2 focus:ring-emerald-500/20 flex-shrink-0 shadow-sm"
                            />
                            
                            {/* Amount: Pure number input, no currency symbol */}
                            <input 
                                type="number" 
                                placeholder="é‡‘é¡" 
                                value={amount} 
                                onChange={e=>setAmount(e.target.value)} 
                                required
                                className="h-full w-full px-4 bg-slate-50 rounded-xl border border-slate-200 outline-none text-lg font-bold text-slate-800 focus:ring-2 focus:ring-emerald-500/20 placeholder:text-slate-300 placeholder:font-normal"
                            />
                        </div>

                        {/* Row 2: Item Name (Big) | Button */}
                        <div className="flex gap-2 items-center h-12">
                            <div className="relative flex-grow h-full">
                                <input 
                                    type="text" 
                                    placeholder="æ¶ˆè²»é …ç›® (ä¾‹å¦‚: è¿ªå£«å°¼é–€ç¥¨)" 
                                    value={item} 
                                    onChange={e=>setItem(e.target.value)} 
                                    required
                                    className="h-full w-full px-4 bg-slate-50 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500/20 text-sm font-medium"
                                />
                            </div>
                             <button type="submit" className="h-full bg-emerald-600 text-white px-5 rounded-xl font-bold shadow-md active:scale-95 transition-transform flex items-center justify-center flex-shrink-0 w-16">
                                {editingId ? <CheckIcon className="w-6 h-6"/> : <PlusIcon className="w-6 h-6"/>}
                            </button>
                        </div>
                    </form>

                    {/* List */}
                    <div className="space-y-6">
                        {expensesByDate.map(group => (
                            <div key={group.date} className="fade-in">
                                <div className="flex justify-between items-end px-2 mb-2">
                                    <div className="font-bold text-slate-600 text-sm bg-slate-100 px-3 py-1 rounded-full">{group.date}</div>
                                    <div className="text-xs font-bold text-emerald-600">å°è¨ˆ: NT$ {Math.round(group.total).toLocaleString()}</div>
                                </div>
                                <div className="space-y-2">
                                    {group.items.map(ex => (
                                        <div key={ex.id} className="bg-white p-3 rounded-2xl border-2 border-blue-200 shadow-md shadow-blue-50/50 flex justify-between items-center transition-all hover:shadow-lg hover:border-blue-300">
                                            <div>
                                                <div className="font-bold text-slate-800 text-sm">{ex.item}</div>
                                                <div className="text-xs text-slate-400 mt-0.5">
                                                    {ex.amount.toLocaleString()} {ex.currency} <span className="opacity-50">â‰ˆ</span> <span className="text-slate-500 font-medium">NT$ {Math.round(ex.twdAmount).toLocaleString()}</span>
                                                </div>
                                            </div>
                                            <div className="flex gap-1">
                                                <button onClick={()=>handleEdit(ex)} className="p-2 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors">
                                                    <Edit3Icon className="w-4 h-4"/>
                                                </button>
                                                <button onClick={()=>handleDelete(ex.id)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                                                    <Trash2Icon className="w-4 h-4"/>
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                        {expenses.length === 0 && (
                            <div className="text-center text-slate-400 py-10 bg-slate-50/50 rounded-3xl border border-dashed border-slate-200">
                                <WalletIcon className="w-8 h-8 mx-auto mb-2 opacity-20"/>
                                å°šç„¡æ”¯å‡ºç´€éŒ„
                            </div>
                        )}
                    </div>
                </div>
            )
        };

        // --- Exchange Rate Widget ---
        const ExchangeRateWidget = ({ rates, updated }) => {
            const [amount, setAmount] = useState('');
            const [currency, setCurrency] = useState('JPY');
            const result = rates ? (amount / rates[currency]).toLocaleString('zh-TW', {style:'currency', currency:'TWD'}) : '---';

            return (
                <div className="bg-white rounded-3xl p-6 shadow-sm border border-slate-200 fade-in">
                    <div className="flex items-center justify-between mb-6">
                        <h3 className="font-bold text-slate-700 flex items-center gap-2"><CalculatorIcon className="w-5 h-5 text-indigo-500" /> åŒ¯ç‡æ›ç®—</h3>
                    </div>
                    <div className="space-y-4">
                        <div className="flex gap-2">
                            <select value={currency} onChange={e=>setCurrency(e.target.value)} className="bg-slate-100 rounded-xl px-4 py-3 font-bold text-slate-700 outline-none cursor-pointer">
                                <option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option>
                                <option value="USD">ğŸ‡ºğŸ‡¸ USD</option>
                                <option value="KRW">ğŸ‡°ğŸ‡· KRW</option>
                                <option value="EUR">ğŸ‡ªğŸ‡º EUR</option>
                                <option value="CNY">ğŸ‡¨ğŸ‡³ CNY</option>
                            </select>
                            <input type="number" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="å¤–å¹£é‡‘é¡" className="flex-grow bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500/20" />
                        </div>
                        <div className="flex justify-center"><ArrowRightLeftIcon className="w-5 h-5 text-slate-300 rotate-90" /></div>
                        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl p-4 text-white text-center shadow-lg shadow-indigo-200">
                            <div className="text-2xl font-bold">{result}</div>
                        </div>
                        <div className="text-center text-xs text-slate-400">æ›´æ–°: {updated}</div>
                    </div>
                </div>
            );
        };

        // --- Weather Widget ---
        const WeatherWidget = () => {
            const [forecast, setForecast] = useState(null);
            const [loading, setLoading] = useState(false);
            const [cityName, setCityName] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [savedLocs, setSavedLocs] = useState(() => {
                const s = localStorage.getItem('vibeSavedWeather');
                return s ? JSON.parse(s) : [];
            });
            const [currentCoords, setCurrentCoords] = useState(null);
            useEffect(() => { localStorage.setItem('vibeSavedWeather', JSON.stringify(savedLocs)); }, [savedLocs]);
            const fetchWeather = async (lat, lon, name) => {
                setLoading(true);
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto`);
                    const data = await res.json();
                    setForecast(data);
                    setCityName(name);
                    setCurrentCoords({ lat, lon, name });
                    setLoading(false);
                } catch (e) { console.error(e); setLoading(false); }
            };
            const handleSelectLocation = (item) => {
                setSearchQuery(item.display_name.split(',')[0]);
                fetchWeather(item.lat, item.lon, item.display_name.split(',')[0]);
            };
            const toggleSave = () => {
                if (!currentCoords) return;
                const exists = savedLocs.find(l => l.name === currentCoords.name);
                if (exists) setSavedLocs(savedLocs.filter(l => l.name !== currentCoords.name));
                else setSavedLocs([...savedLocs, currentCoords]);
            };
            const isSaved = currentCoords && savedLocs.find(l => l.name === currentCoords.name);
            return (
                <div className="fade-in space-y-4">
                     <div className="bg-white p-4 rounded-3xl shadow-sm border border-slate-200">
                        <div className="mb-2 text-sm font-bold text-slate-500">æŸ¥è©¢å¤©æ°£</div>
                        <div className="flex gap-2">
                             <SmartLocationInput value={searchQuery} onChange={setSearchQuery} placeholder="è¼¸å…¥åŸå¸‚..." required={false} onSelectCallback={handleSelectLocation}/>
                        </div>
                        {savedLocs.length > 0 && (
                            <div className="flex flex-wrap gap-2 mt-4">
                                {savedLocs.map((loc, idx) => (
                                    <button key={idx} onClick={() => { setSearchQuery(loc.name); fetchWeather(loc.lat, loc.lon, loc.name); }} className={`px-3 py-1 rounded-full text-xs font-bold transition-colors ${cityName === loc.name ? 'bg-blue-100 text-blue-600 border border-blue-200' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                        {loc.name}
                                    </button>
                                ))}
                            </div>
                        )}
                     </div>
                     {loading && <div className="text-center py-10 text-slate-400">è®€å–ä¸­...</div>}
                     {!loading && forecast && (
                         <div className="animate-in fade-in slide-in-from-bottom-4">
                             <div className="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-3xl p-6 text-white shadow-lg shadow-blue-200 mb-6 relative overflow-hidden">
                                <div className="relative z-10 flex justify-between items-start">
                                    <div><h3 className="text-2xl font-bold flex items-center gap-2">{cityName}</h3><p className="text-blue-100 text-sm mt-1">æœªä¾† 7 å¤©é å ±</p></div>
                                    <button onClick={toggleSave} className={`p-2 rounded-full transition-colors ${isSaved ? 'bg-white text-red-500' : 'bg-white/20 text-white hover:bg-white/30'}`}><HeartIcon className={`w-6 h-6 ${isSaved ? 'fill-current' : ''}`} /></button>
                                </div>
                             </div>
                             <div className="grid grid-cols-1 gap-3">
                                {forecast.daily.time.map((date, idx) => (
                                    <div key={idx} className="bg-white p-4 rounded-2xl flex items-center justify-between border border-slate-100 shadow-sm">
                                        <div className="flex items-center gap-4">
                                            <div className="text-slate-500 font-bold w-12 text-sm">{idx === 0 ? 'ä»Šå¤©' : date.slice(5)}</div>
                                            {getWeatherIcon(forecast.daily.weathercode[idx])}
                                        </div>
                                        <div className="text-right">
                                            <div className="font-bold text-slate-700">{getWeatherDesc(forecast.daily.weathercode[idx])}</div>
                                            <div className="text-xs text-slate-400">{forecast.daily.temperature_2m_min[idx]}Â° - {forecast.daily.temperature_2m_max[idx]}Â°C</div>
                                        </div>
                                    </div>
                                ))}
                             </div>
                         </div>
                     )}
                </div>
            );
        };

        // --- Main App ---
        const VibeTravelApp = () => {
            const [itinerary, setItinerary] = useState(() => {
                const s = localStorage.getItem('vibeTravelData_v6');
                const data = s ? JSON.parse(s) : [];
                if (data.length === 0) return [{ id: Date.now(), dayTitle: 'Day 1', date: '', activities: [] }];
                return data;
            });
            const [expenses, setExpenses] = useState(() => {
                const s = localStorage.getItem('vibeExpenses');
                return s ? JSON.parse(s) : [];
            });
            const [tripTitle, setTripTitle] = useState(() => localStorage.getItem('vibeTravelTitle_v6') || 'æˆ‘çš„ Vibe ä¹‹æ—…');
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const [rates, setRates] = useState(null);
            const [ratesUpdated, setRatesUpdated] = useState('');
            const [activeTab, setActiveTab] = useState(() => {
                 const s = localStorage.getItem('vibeTravelData_v6');
                 const data = s ? JSON.parse(s) : [];
                 if (data.length > 0) return data[0].id;
                 return 'temp';
            });

            useEffect(() => {
                const fetchGlobalRates = async () => {
                    try {
                        const res = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                        const data = await res.json();
                        setRates(data.rates);
                        setRatesUpdated(new Date(data.time_last_updated * 1000).toLocaleDateString());
                    } catch (e) { console.error("Rate fetch failed", e); }
                };
                fetchGlobalRates();
            }, []);

            useEffect(() => {
                if (activeTab === 'temp' && itinerary.length > 0) setActiveTab(itinerary[0].id);
            }, [itinerary]);

            useEffect(() => {
                localStorage.setItem('vibeTravelData_v6', JSON.stringify(itinerary));
                localStorage.setItem('vibeTravelTitle_v6', tripTitle);
            }, [itinerary, tripTitle]);

            const addDay = () => {
                const newDay = { id: Date.now(), dayTitle: `Day ${itinerary.length + 1}`, date: '', activities: [] };
                setItinerary([...itinerary, newDay]);
                setActiveTab(newDay.id);
            };

            const deleteDay = (id) => {
                if(confirm('åˆªé™¤é€™å¤©ï¼Ÿ')) {
                    const newItinerary = itinerary.filter(d => d.id !== id);
                    setItinerary(newItinerary);
                    if(activeTab === id) setActiveTab(newItinerary.length > 0 ? newItinerary[0].id : 'exchange');
                }
            };

            const addActivity = (dayId, time, location) => {
                setItinerary(itinerary.map(d => {
                    if(d.id === dayId) {
                        return { ...d, activities: [...d.activities, { id: Date.now(), time, location }].sort((a,b)=>a.time.localeCompare(b.time)) };
                    }
                    return d;
                }));
            };

            const updateActivity = (dayId, actId, newTime, newLocation) => {
                 setItinerary(itinerary.map(d => {
                    if(d.id === dayId) {
                         const updatedActivities = d.activities.map(a => 
                            a.id === actId ? { ...a, time: newTime, location: newLocation } : a
                         ).sort((a,b)=>a.time.localeCompare(b.time));
                         return { ...d, activities: updatedActivities };
                    }
                    return d;
                }));
            };

            const deleteActivity = (dayId, actId) => {
                setItinerary(itinerary.map(d => d.id === dayId ? { ...d, activities: d.activities.filter(a => a.id !== actId) } : d));
            };

            const updateDate = (dayId, newDate) => {
                 setItinerary(itinerary.map(d => d.id === dayId ? { ...d, date: newDate } : d));
            };

            // Export Data Function - CSV Format (Clean amount, Currency in Header, Removed Currency Column)
            const handleExport = () => {
                const tripCurrency = localStorage.getItem('vibeExpenseDefaultCurrency') || 'JPY';
                let csvContent = `\uFEFFæ—…éŠæ¨™é¡Œ,${tripTitle}\nåŒ¯å‡ºæ—¥æœŸ,${new Date().toLocaleDateString()}\n\n`;
                
                // 1. Itinerary
                csvContent += `--- è¡Œç¨‹è¦åŠƒ ---\nå¤©æ•¸,æ—¥æœŸ,æ™‚é–“,åœ°é»\n`;
                itinerary.forEach(day => {
                    const dayStr = day.dayTitle;
                    const dateStr = day.date || '';
                    if (day.activities.length === 0) { csvContent += `${dayStr},${dateStr},,\n`; } 
                    else {
                        day.activities.forEach(act => {
                            const loc = `"${act.location.replace(/"/g, '""')}"`;
                            csvContent += `${dayStr},${dateStr},${act.time},${loc}\n`;
                        });
                    }
                });

                // 2. Expenses Sorted by Date with Subtotals
                // Removed Currency column, Header includes currency info
                csvContent += `\n--- è²»ç”¨ç´€éŒ„ ---\næ—¥æœŸ,æ¶ˆè²»é …ç›®,åŸå¹£é‡‘é¡ (${tripCurrency}),å°å¹£(é ä¼°)\n`;
                
                const savedExpenses = JSON.parse(localStorage.getItem('vibeExpenses') || '[]');
                savedExpenses.sort((a, b) => {
                    const dateA = a.date || '9999-99-99';
                    const dateB = b.date || '9999-99-99';
                    return dateA.localeCompare(dateB);
                });

                let grandTotalTWD = 0;
                let currentGroupDate = null;
                let dailyTotalTWD = 0;

                savedExpenses.forEach((ex, index) => {
                    const exDate = ex.date || 'æœªè¨­å®šæ—¥æœŸ';
                    if (currentGroupDate !== null && exDate !== currentGroupDate) {
                        csvContent += `,,,æœ¬æ—¥å°è¨ˆ ${Math.round(dailyTotalTWD)}\n`;
                        dailyTotalTWD = 0;
                    }
                    currentGroupDate = exDate;
                    const item = `"${ex.item.replace(/"/g, '""')}"`;
                    
                    // Fixed: Pure numbers in CSV, removed redundant currency column
                    csvContent += `${exDate},${item},${ex.amount},${Math.round(ex.twdAmount)}\n`;
                    
                    dailyTotalTWD += ex.twdAmount;
                    grandTotalTWD += ex.twdAmount;

                    if (index === savedExpenses.length - 1) {
                         csvContent += `,,,æœ¬æ—¥å°è¨ˆ ${Math.round(dailyTotalTWD)}\n`;
                    }
                });

                csvContent += `\n*** ç¸½è¨ˆ ***,,,${Math.round(grandTotalTWD)}\n`;

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `VibeTravel_${tripTitle}_Export.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const currentDay = itinerary.find(d => d.id === activeTab);

            return (
                <div className="min-h-screen pb-20 max-w-md mx-auto md:max-w-3xl md:border-x md:border-slate-200 bg-white md:shadow-2xl flex flex-col">
                    <div className="bg-white sticky top-0 z-20 px-4 pt-6 pb-2 border-b border-slate-100/50 backdrop-blur-md bg-white/80">
                         <div className="flex justify-between items-center mb-4">
                            <div className="flex-grow flex justify-center items-center gap-2">
                                {isEditingTitle ? (
                                    <div className="flex items-center gap-2 w-full max-w-xs animate-in fade-in zoom-in">
                                        <input autoFocus type="text" value={tripTitle} onChange={e=>setTripTitle(e.target.value)} onBlur={()=>setIsEditingTitle(false)} onKeyDown={e=>e.key==='Enter'&&setIsEditingTitle(false)} className="text-xl font-bold text-center w-full border-b-2 border-indigo-500 outline-none bg-transparent"/>
                                        <button onClick={()=>setIsEditingTitle(false)}><CheckIcon className="w-5 h-5 text-indigo-600"/></button>
                                    </div>
                                ) : (
                                    <h1 onClick={()=>setIsEditingTitle(true)} className="text-xl font-bold text-slate-800 flex items-center gap-2 cursor-pointer hover:text-indigo-600 transition-colors">
                                        {tripTitle} <Edit3Icon className="w-4 h-4 text-slate-300"/>
                                    </h1>
                                )}
                            </div>
                            <button onClick={handleExport} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-slate-100 rounded-full transition-colors" title="åŒ¯å‡º CSV å ±è¡¨"><DownloadIcon className="w-5 h-5"/></button>
                        </div>
                        <div className="flex items-center gap-2 overflow-x-auto no-scrollbar pb-2">
                            {itinerary.map((day) => (
                                <button key={day.id} onClick={() => setActiveTab(day.id)} className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all ${activeTab === day.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                    {day.dayTitle}
                                </button>
                            ))}
                            <button onClick={addDay} className="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-600 hover:bg-indigo-100 hover:text-indigo-600 transition-colors"><PlusIcon className="w-4 h-4" /></button>
                            <div className="w-[1px] h-6 bg-slate-200 mx-1 flex-shrink-0"></div>
                            <button onClick={() => setActiveTab('expenses')} className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all flex items-center gap-1 ${activeTab === 'expenses' ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-200' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                <WalletIcon className="w-3 h-3"/> è²»ç”¨
                            </button>
                            <button onClick={() => setActiveTab('weather')} className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all flex items-center gap-1 ${activeTab === 'weather' ? 'bg-blue-500 text-white shadow-lg shadow-blue-200' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                <CloudIcon className="w-3 h-3"/> å¤©æ°£
                            </button>
                            <button onClick={() => setActiveTab('exchange')} className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all flex items-center gap-1 ${activeTab === 'exchange' ? 'bg-purple-600 text-white shadow-lg shadow-purple-200' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                <CalculatorIcon className="w-3 h-3"/> åŒ¯ç‡
                            </button>
                        </div>
                    </div>

                    <div className="p-4 bg-slate-50 flex-grow min-h-[500px]">
                        {activeTab === 'exchange' && <div className="max-w-sm mx-auto mt-4"><ExchangeRateWidget rates={rates} updated={ratesUpdated} /></div>}
                        {activeTab === 'weather' && <div className="max-w-sm mx-auto mt-4"><WeatherWidget /></div>}
                        {activeTab === 'expenses' && <div className="max-w-md mx-auto mt-2"><ExpenseTracker rates={rates} /></div>}

                        {activeTab !== 'exchange' && activeTab !== 'weather' && activeTab !== 'expenses' && currentDay && (
                            <div className="fade-in pb-24">
                                <AddActivityForm onAdd={(time, loc) => addActivity(currentDay.id, time, loc)} />
                                <div className="flex justify-between items-center px-2 mb-3">
                                    <div className="flex items-center gap-2">
                                         <div className="relative">
                                            <input 
                                                type="date" 
                                                value={currentDay.date} 
                                                onChange={(e) => updateDate(currentDay.id, e.target.value)}
                                                className="bg-indigo-50 border-2 border-indigo-100 text-indigo-700 rounded-lg py-1.5 px-2 text-lg font-bold focus:outline-none focus:border-indigo-400 date-input-custom shadow-sm"
                                            />
                                        </div>
                                        <div className="text-indigo-900 font-bold opacity-50 text-sm uppercase tracking-wider">{currentDay.dayTitle}</div>
                                    </div>
                                    <button onClick={() => deleteDay(currentDay.id)} className="text-xs text-red-400 hover:text-red-600 hover:underline flex items-center gap-1">
                                        <Trash2Icon className="w-3 h-3" /> åˆªé™¤é€™å¤©
                                    </button>
                                </div>
                                <div className="space-y-3">
                                    {currentDay.activities.length === 0 ? (
                                        <div className="text-center py-10 bg-white rounded-2xl border border-dashed border-slate-300">
                                            <div className="text-slate-400 mb-2">ğŸ‘‹ é€™è£¡ç©ºç©ºçš„</div>
                                            <div className="text-xs text-slate-400">ä½¿ç”¨ä¸Šæ–¹è¡¨å–®æ–°å¢ç¬¬ä¸€å€‹æ™¯é»ï¼</div>
                                        </div>
                                    ) : (
                                        currentDay.activities.map(act => (
                                            <ActivityItem key={act.id} act={act} onDelete={()=>deleteActivity(currentDay.id, act.id)} onUpdate={(actId, t, l) => updateActivity(currentDay.id, actId, t, l)}/>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VibeTravelApp />);
    </script>
</body>
</html>


